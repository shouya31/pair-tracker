# 集約と値オブジェクトの設計ルール（改訂版）

## 1. 基本方針

本プロジェクトでは、ドメインモデルの豊かさと堅牢性を高めるため、以下の2つを設計の方針とします。

- **値オブジェクトの積極的な活用**
  単なるプリミティブ型（string, number）ではなく、ビジネス上の意味と制約を持つ **値オブジェクト（Value Object）** としてモデル化する。

- **集約による整合性の保証**
  関連するオブジェクトを **集約（Aggregate）としてまとめ、その集約ルート（Aggregate Root）** が内部の整合性を完全に保証する。

---

## 2. 値オブジェクト（Value Object）のルール

- **定義**:
  値そのものが意味を持ち、不変（Immutable）であるオブジェクト。

- **責務**:
  - 自身の不変条件（フォーマット、文字数、範囲など）をコンストラクタまたは静的ファクトリメソッド（`create`）で保証する。
  - 不正な値で生成しようとした場合、エラーをスローする。

- **例**
  `Email`, `TeamName`, `IssueTitle` など。

- **補足**
  - 複数のドメインで共通して使用できるValue Object（例: Email）は、特定のドメインではなく共通のディレクトリ（domain/shared）に配置する
  - これにより、Value Objectの再利用性が高まり、重複実装を防ぐことができる

---

## 3. 集約（Aggregate）のルール

- **定義**:
  データ整合性の単位となる、1つまたは複数のエンティティ・値オブジェクトのまとまり。

- **ルール**:
  - 外部からのアクセスは必ず集約ルートを経由する（集約内部のオブジェクトを直接変更しない）。
  - 整合性は集約ルートが責任を持つ（集約全体のビジネスルールを集約ルートが検証・管理する）。
  - トランザクションは集約単位（1つのトランザクションで、複数の集約ルートをまたいで変更しない）。
  - 他の集約はIDで参照する（他の集約をオブジェクトとして直接持たず、IDで参照する）。

---

## 4. 本プロジェクトにおける集約と値オブジェクト

### 4-1. User集約

- **集約ルート**: `User` エンティティ
- **値オブジェクト**:
  - `Email`: メールのフォーマットを保証する。
  - `UserName`: 名前の制約（例: 空でないこと）を保証する。
- **集約の不変条件**:
  - ユーザーのメールアドレスは一意である。
  - ユーザーのステータスは定義されたもの（在籍中、休会中、退会済）のいずれかである。

---

### 4-2. Team集約

- **集約ルート**: `Team` エンティティ
- **子エンティティ**: `Pair` エンティティ
- **値オブジェクト**:
  - `TeamName`: チーム名が3文字以下である制約を保証する。
  - `PairLabel`: ペア名が英文字1文字である制約を保証する。
- **集約の不変条件**:
  - チーム名は一意である。
  - チームには常に最低3名のユーザーが所属している。
  - チームに所属するメンバーは全員「在籍中」である。
  - ペアを構成するメンバーは、必ずその `Team` に所属していなければならない。
- **ルール**:
  - `Pair` の生成・変更・削除は、必ず `Team` 集約ルートのメソッド（例: `team.formPair(...)`）を通じて行われる。
  - `IPairRepository` は存在しない。`Pair` のデータ操作は `ITeamRepository` が `Team` 集約全体を扱うことで実現する。

- **設計の背景: なぜ`Pair`は`Team`の内部にあるのか？**
  - ビジネスルールに「ペアは必ず同じチームに所属するユーザーから選ばれなければなりません」と定義されています。これは、Pairの整合性がTeamの状態（所属メンバー）に強く依存していることを意味します。
  - もしPairを独立した集約としてしまうと、この整合性を保つためのチェックが複雑化し、複数の集約にまたがるトランザクション管理が必要になる可能性があります。
  - PairをTeam集約の子エンティティとすることで、Team集約ルートがこのルールに対する責任を完全に持つことができます。team.formPair()メソッド内で「このメンバーは本当にチームの一員であるか？」という検証を完結させることができます。

---

### 4-3. Issue（課題）集約

- **集約ルート**: `Issue` エンティティ
- **値オブジェクト**:
  - `IssueTitle`: 課題名が1〜20文字である制約を保証する。
- **集約の不変条件**:
  - 課題の進捗ステータスは定義されたもの（未着手、レビュー待ち、完了）のいずれかである。
  - 進捗ステータスを変更できるのは、その課題の担当者のみである。
- **他の集約の参照**:
  - `Issue` は、作成者と担当者として `User` 集約を **ID (`userId`)** で参照する。
